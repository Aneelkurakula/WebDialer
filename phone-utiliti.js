function storageLoadConfig(e,t=null,s=!0,i=!1){let r,a=localStorage.getItem(e),o=null,n=!1,l=!1;return a&&(n=!0,o=JSON.parse(a)),null===o||null!==t&&o.version!==t.version?(n&&(l=!0),n=!1,r=!0,null!==t&&(o=Object.assign({},t))):r=dataEquals(o,t),s&&ac_log("Used %s %s",null!==o?r?"default":"custom":"null",e),null!==o&&(l||i&&!n)&&localStorage.setItem(e,JSON.stringify(o)),o}function storageSaveConfig(e,t,s=null){null!==s&&dataEquals(t,s)?localStorage.removeItem(e):(null!==s&&s.version&&!t.version&&(t.version=s.version),localStorage.setItem(e,JSON.stringify(t)))}function dataEquals(e,t){if(null===e||null===t)return e===t;for(let s in e){if(e.hasOwnProperty(s)!==t.hasOwnProperty(s))return!1;switch(typeof e[s]){case"object":if(!dataEquals(e[s],t[s]))return!1;break;case"function":break;default:if(e[s]!=t[s])return!1}}for(let s in t)if(void 0===e[s])return!1;return!0}class AbstractDb{constructor(e,t,s){this.dbName=e,this.storeName=t,this.maxSize=s,this.db=null,this.list=[],this.idSeqNumber=-1}createId(e){return this.idSeqNumber=(this.idSeqNumber+1)%1e6,Math.random().toString(36).substr(2,9)}open(){return new Promise((e,t)=>{let s=indexedDB.open(this.dbName);s.onupgradeneeded=(e=>{e.target.result.createObjectStore(this.storeName,{keyPath:"id"})}),s.onsuccess=(()=>{this.db=s.result,e()}),s.onerror=s.onblocked=(()=>{t(s.error)})})}load(){return new Promise((e,t)=>{if(null===this.db)return void t("db is null");let s=this.db.transaction(this.storeName,"readwrite");s.onerror=(()=>{t(s.error)});let i=s.objectStore(this.storeName);(i.getAll?this._getAllBuiltIn:this._getAllCursor)(i,s=>{this.list=s;let r=this.list.length-this.maxSize;if(r<=0)e();else{let s=i.delete(IDBKeyRange.upperBound(this.list[r-1].id));s.onerror=(()=>{t(s.error)}),s.onsuccess=(()=>{this.list=this.list.splice(-maxSize),e()})}},e=>{t(e)})})}_getAllBuiltIn(e,t,s){let i=e.getAll();i.onerror=(()=>s(i.error)),i.onsuccess=(()=>t(i.result))}_getAllCursor(e,t,s){let i=[],r=e.openCursor();r.onerror=(()=>s(r.error)),r.onsuccess=(e=>{let s=e.target.result;s?(i.push(s.value),s.continue()):t(i)})}add(e){return new Promise((t,s)=>{if(null===this.db)return void s("db is null");let i=this.db.transaction(this.storeName,"readwrite");i.onerror=(()=>{s(i.error)});let r=i.objectStore(this.storeName),a=r.add(e);a.onerror=(()=>{s(a.error)}),a.onsuccess=(()=>{this.list.push(e);let i=this.list.length-this.maxSize;i<=0?t():((a=r.delete(IDBKeyRange.upperBound(this.list[i-1].id))).onerror=(()=>{s(a.error)}),a.onsuccess=(()=>{this.list=this.list.splice(-this.maxSize),t()}))})})}update(e){let t=this.list.findIndex(t=>t.id===e.id);return-1==t?Promise.reject("Record is not found"):(this.list[t]=e,this._exec("put",this.storeName,e))}delete(e,t=this.storeName){if(t===this.storeName){let t=this.list.findIndex(t=>t.id===e);if(-1==t)return Promise.reject("Record is not found");this.list.splice(t,1)}return this._exec("delete",t,e)}clear(e=this.storeName){return this.list=[],this._exec("clear",e)}get(e,t){return this._exec("get",t,e)}put(e,t){return this._exec("put",t,e)}_exec(e,t,s){return new Promise((i,r)=>{if(null===this.db)return void r("db is null");let a=this.db.transaction(t,"readwrite");a.onerror=(()=>{r(a.error)});let o,n=a.objectStore(t);switch(e){case"clear":o=n.clear();break;case"delete":o=n.delete(s);break;case"put":o=n.put(s);break;case"get":o=n.get(s);break;default:return void r("db: wrong request")}o.onerror=(()=>{r(o.error)}),o.onsuccess=(()=>{i(o.result)})})}}class CallLogDb extends AbstractDb{constructor(e){super("phone","call_log",e)}}class VoiceDb extends AbstractDb{constructor(e){super("voice_db","records",e)}open(){return new Promise((e,t)=>{let s=indexedDB.open(this.dbName);s.onupgradeneeded=(e=>{e.target.result.createObjectStore(this.storeName,{keyPath:"id"}),e.target.result.createObjectStore("greeting",{keyPath:"id"})}),s.onsuccess=(()=>{this.db=s.result,e()}),s.onerror=s.onblocked=(()=>{t(s.error)})})}}class MessageDb extends AbstractDb{constructor(e){super("message_db","messages",e)}}class AudioPlayer{constructor(e=!0){this.logger=console.log,this.audioCtx=null,this.sounds={},this.source=null,this.resolve=null,this.gain=null,this.streamDestination=null,this.dtmfSuite={1:[{f:[697,1209],t:.2}],2:[{f:[697,1336],t:.2}],3:[{f:[697,1477],t:.2}],4:[{f:[770,1209],t:.2}],5:[{f:[770,1336],t:.2}],6:[{f:[770,1477],t:.2}],7:[{f:[852,1209],t:.2}],8:[{f:[852,1336],t:.2}],9:[{f:[852,1477],t:.2}],"*":[{f:[941,1209],t:.2}],0:[{f:[941,1336],t:.2}],"#":[{f:[941,1477],t:.2}]},this.browser=this._browser(),this.encodings={chrome:["mp3","ogg","aac"],firefox:["ogg","mp3","aac"],safari:["aac","mp3"],other:["mp3","aac","ogg"]}[this.browser],e&&(this.createCtx(),this.isDisabled()&&console.log("AudioPlayer: AudioContext is suspended [Autoplay Policy]"))}_browser(){return navigator.mozGetUserMedia?"firefox":navigator.webkitGetUserMedia?"chrome":window.safari?"safari":"other"}createCtx(){try{this.audioCtx=new(window.AudioContext||window.webkitAudioContext)}catch(e){this.logger("AudioPlayer: cannot create audioContext",e)}}init(e,t){this.logger=e,void 0!==t&&(this.audioCtx=t),"safari"===this.browser&&this._setDecodeAudioDataShim(this.audioCtx)}_setDecodeAudioDataShim(e){let t=e.decodeAudioData;e.decodeAudioData=(s=>new Promise((i,r)=>{t.call(e,s,e=>i(e),e=>r(e))}))}_setStartRenderingShim(e){let t=e.startRendering;e.startRendering=(()=>new Promise(s=>{e.oncomplete=(e=>{s(e.renderedBuffer)}),t.call(e)}))}isDisabled(){switch(this.browser){case"chrome":case"safari":return this.isSuspended();default:return!1}}enable(){switch(this.browser){case"chrome":case"safari":return this.resume();default:return Promise.resolve()}}isSuspended(){return"suspended"===this.audioCtx.state}resume(){return this.audioCtx.resume()}suspend(){return this.audioCtx.suspend()}play(e){return this.audioCtx?this.isDisabled()&&e.dropDisabled?Promise.resolve("drop sound for disabled"):new Promise((t,s)=>{this.stop(),this.resolve=t;try{let i=this.sounds[e.name];if(!i)return this.logger("AudioPlayer: no sound: "+e.name),void s("No sound");this.logger("AudioPlayer: play:",e),this.source=this.audioCtx.createBufferSource(),this.source.buffer=i,this.source.onended=(s=>{this.logger("AudioPlayer: onended "+e.name),t(!0)}),this.source.onerror=(e=>{this.logger("AudioPlayer: onerror callback",e),this._releaseResources(),s("onerror callback")}),this.gain=this.audioCtx.createGain();let r=e.volume?e.volume:1;this.gain.gain.setValueAtTime(r,this.audioCtx.currentTime),this.source.connect(this.gain),e.streamDestination?(this.streamDestination=e.streamDestination,this.gain.connect(this.streamDestination)):(this.streamDestination=null,this.gain.connect(this.audioCtx.destination));let a=e.clipStart?e.clipStart:0,o=e.clipEnd?e.clipEnd:null;(!0===e.loop||e.repeat)&&(this.source.loop=!0,this.source.loopStart=a,o&&(this.source.loopEnd=o));let n=null;e.duration?n=e.duration:e.repeat?(null===o&&(o=this.source.buffer.duration),n=(o-a)*e.repeat):null!==o&&(n=o-a);let l=0;e.startDelay&&(l=this.audioCtx.currentTime+e.startDelay,n&&(n+=e.startDelay)),this.source.start(l,a),n&&this.source.stop(this.audioCtx.currentTime+n)}catch(e){this.logger("AudioPlayer: play error",e),s(e)}}):Promise.reject("No audio context")}_releaseResources(){this.source&&this.logger("AudioPlayer: release resources");try{this.source&&this.source.stop()}catch(e){}try{this.gain&&this.gain.disconnect(),this.source&&this.source.disconnect(),this.streamDestination&&this.streamDestination.disconnect(),this.gain=null,this.source=null,this.streamDestination=null}catch(e){this.logger("AudioPlayer: release resources error",e)}}stop(){this._releaseResources(),this.resolve&&(this.resolve("stopped externally"),this.resolve=null)}async downloadSounds(e,t,s=this.encodings,i=!1){this.logger("AudioPlayer: downloadSounds",t);for(let r of t)await this.downloadSound(e,r,s,i)}async downloadSound(e,t,s=this.encodings,i=!1){let r=null;for(let a of s){let s=t+"."+a,o=null,n=Date.now();try{let t=await fetch(e+s,{credentials:"same-origin"});o=await t.arrayBuffer()}catch(e){continue}let l=Date.now();try{if(r=await this.audioCtx.decodeAudioData(o),!i)break;let e=Date.now();this.logger("AudioPlayer [test] "+s+" is downloaded (%s) and decoded (%s)",((l-n)/1e3).toFixed(3),((e-l)/1e3).toFixed(3))}catch(e){this.logger("AudioPlayer: decoding error: "+s,e);continue}}return null!==r?this.sounds[t]=r:this.logger("AudioPlayer: Cannot download & decode: "+t),r}generateTone(e,t){function s(e){return void 0===e?[]:Array.isArray(e)?e:[e]}try{let i=0,r=0;for(let e of t)i+=e.t,r=Math.max(r,s(e.f).length);let a=1,o=this.audioCtx.sampleRate,n=o*i,l=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(a,n,o);"safari"===this.browser&&this._setStartRenderingShim(l);let h=new Array(r);for(let e=0;e<h.length;e++)h[e]=l.createOscillator(),h[e].connect(l.destination);let c=0;for(let e=0,i=t.length;e<i;e++){let i=t[e],r=s(i.f);for(let e=0;e<h.length;e++){let t=e<r.length?r[e]:0;h[e].frequency.setValueAtTime(t,l.currentTime+c)}c+=i.t}for(let e of h)e.start(0),e.stop(l.currentTime+i);return l.startRendering().then(t=>{for(let e of h)e.disconnect();this.sounds[e]=t})}catch(e){return this.logger("AudioPlayer: cannot generate tone",e),Promise.reject(e)}}async generateTonesSuite(e){for(const t in e)await this.generateTone(t,e[t])}generateTones(e,t){return this.generateTonesSuite(Object.assign({ringingTone:e,busyTone:t},this.dtmfSuite))}}class AudioRecorder{constructor(){this.logger=null,this.audioCtx=null,this.chunks=[],this.recorder=null,this.browser=this._browser(),this.options={chrome:{mimeType:"audio/webm;codec=opus"},firefox:{mimeType:"audio/ogg;codec=opus"},safari:void 0,other:void 0}[this.browser]}_browser(){return navigator.mozGetUserMedia?"firefox":navigator.webkitGetUserMedia?"chrome":window.safari?"safari":"other"}init(e,t){this.logger=e,this.audioCtx=t}isRecording(){return this.recorder&&"recording"===this.recorder.state}recordStream(e){return this.logger("AudioRecorder: recordStream()"),this.create(e),this.start().then(e=>{let t=this.recorder.stream.getTracks();for(let e of t)e.stop();return e})}static canBeUsed(){return"function"==typeof MediaRecorder}create(e){let t=new MediaStream(e.getAudioTracks());this.recorder=new MediaRecorder(t,this.options)}start(){return new Promise((e,t)=>{this.chunks=[],this.recorder.ondataavailable=(e=>{this.chunks.push(e.data)}),this.recorder.onerror=(e=>{t(e)}),this.recorder.onstop=(()=>{e(new Blob(this.chunks,{type:"audio/ogg;codecs=opus"})),this.chunks=[]}),this.recorder.start()})}stop(){this.recorder&&"recording"===this.recorder.state&&(this.logger("AudioRecorder: stop"),this.recorder.stop())}decodeSoundBlob(e){return fetch(URL.createObjectURL(e)).then(e=>e.arrayBuffer()).then(e=>this.audioCtx.decodeAudioData(e))}}class AnsweringMachine{constructor(){this.use=!0,this.startDelay=16,this.recordDuration=20,this.run=!1,this.logger=null,this.call=null,this.streamDest=null,this.answerTimer=null,this.recordingTimer=null}init(e,t){this.audioPlayer=e,this.logger=e.logger,this.audioRecorder=t}startTimer(e,t){this.call=e,this.stopTimer(),this.answerTimer=setTimeout(()=>{this.run=!0,t()},1e3*this.startDelay)}stopTimer(){null!==this.answerTimer&&(clearTimeout(this.answerTimer),this.answerTimer=null)}createPlayerStream(){return this.streamDest=this.audioPlayer.audioCtx.createMediaStreamDestination(),this.streamDest.stream}stop(e){e===this.call&&(this.stopTimer(),this.audioRecorder.stop(),null!==this.recordingTimer&&(clearTimeout(this.recordingTimer),this.recordingTimer=null),this.run=!1)}playGreeting(){return this.audioPlayer.play({name:"greeting",streamDestination:this.streamDest,volume:1,startDelay:1.6}).then(()=>this.audioPlayer.play({name:"beep",volume:.2,streamDestination:this.streamDest}))}recordAnswer(e){return this.audioRecorder.create(e),this.recordingTimer=setTimeout(()=>{this.logger("AnsweringMachine: maximum recording time reached."),this.audioRecorder.stop()},1e3*this.recordDuration),this.audioRecorder.start().then(e=>(this.run=!1,e))}}class AlertInfo{constructor(e){this.parsed=[];try{for(let t of e.getHeaders("alert-info"))for(let e of t.split(","))this._parseHeader(e)}catch(e){ac_log("Alert-Info parsing error",e)}}_parseHeader(e){let t,s=e.split(";");if(!s[0].startsWith("<")||!s[0].endsWith(">"))return;t=s[0].slice(1,-1);let i=new Map;for(let e of s.slice(1)){let t=e.indexOf("=");if(-1!==t){let s=e.substring(0,t),r=e.substring(t+1);r.startsWith('"')&&r.endsWith('"')&&(r=r.slice(1,-1)),i.set(s.toLowerCase(),r.toLowerCase())}}this.parsed.push({url:t,params:i})}exists(){return this.parsed.length>0}param(e,t=0){return t>=this.parsed.length?null:this.parsed[t].params.get(e)}url(e=0){return this.parsed[e].url}getDelay(e=0){let t=this.param("delay",e);return t?parseInt(t):-1}hasAutoAnswer(e=0){return"alert-autoanswer"===this.param("info",e)}}class CallAudioMixer{constructor(e,t){this.audioCtx=e,this.dest=this.audioCtx.createMediaStreamDestination(),this.calls=[];let s=this.audioCtx.createMediaStreamSource(t.getRTCLocalStream());s.connect(this.dest),this.calls.push({call:t,source:s})}close(){null!==this.dest&&(this.dest.disconnect(),this.dest=null);for(let e of this.calls)e.source.disconnect();this.calls=[]}getMix(){return this.dest.stream}add(e){if(-1!==this.calls.findIndex(t=>t.call===e))return!1;let t=e.getRTCRemoteStream(),s=this.audioCtx.createMediaStreamSource(t);return s.connect(this.dest),this.calls.push({call:e,source:s}),!0}remove(e){let t=this.calls.findIndex(t=>t.call===e);return-1!==t&&0!==t&&(this.calls[t].source.disconnect(),this.calls.splice(t,1),!0)}toString(){return"audio mixer "+this.calls.map(e=>e.call.data._line_index+1)}}class CallVideoMixer{constructor(){this.layout="compact",this.run=!1,this.calls=[],this.localVideo=null,this.canvas=null,this.canvasCtx=null,this.canvasBackground="#F5F5F5",this.width=160,this.height=120,this.nVideo=0,this.drawInterval=100,this.remoteVideoId="",this.frame=1,this.data={}}setElements(e,t,s){this.canvas=document.getElementById(e),this.canvasCtx=this.canvas.getContext("2d"),this.localVideo=document.getElementById(t),this.remoteVideoId=s}setFPS(e){this.setDrawInterval(1e3/e)}setDrawInterval(e){this.drawInterval=e}setLayout(e){switch(e){case"linear":case"compact":this.layout=e;break;default:throw"Unknown layout: "+e}this.resize()}setSize(e,t){this.width=e,this.height=t,this.resize()}setSizes(e){let t=parseInt(e.width.slice(0,-2)),s=parseInt(e.height.slice(0,-2));this.setSize(t,s)}isOn(){return this.run}start(){this.run||(setTimeout(this._draw.bind(this),this.drawInterval),this.run=!0)}stop(){for(;this.calls.length>0;)this.remove(this.calls[0].call);this.run=!1}getMix(e){let t=this.calls.findIndex(t=>t.call===e);return-1!==t?this.calls[t].mix:null}add(e,t=!0,s=!0){let i=this.calls.findIndex(t=>t.call===e);return-1===i?this._add(e,t,s):this._update(i,t,s)}_add(e,t,s){let i=t?this.canvas.captureStream():null,r=s?document.getElementById(this.remoteVideoId+e.data._line_index):null;return this.calls.push({call:e,elt:r,mix:i,x:0,y:0}),null!==r&&this.resize(),null!==i}_update(e,t,s){let i=this.calls[e],r=!1;if(t)null===i.mix&&(i.mix=this.canvas.captureStream(),r=!0);else if(null!==i.mix){for(let e of i.mix.getVideoTracks())e.stop();i.mix=null,r=!0}return s?null===i.elt&&(i.elt=document.getElementById(this.remoteVideoId+i.call.data._line_index),this.resize()):null!==i.elt&&(i.elt=null,this.resize()),r}remove(e){let t=this.calls.findIndex(t=>t.call===e);if(-1===t)return!1;let s=this.calls[t];if(null!==s.mix)for(let e of s.mix.getVideoTracks())e.stop();return this.calls.splice(t,1),null!==s.elt&&this.resize(),!0}_nVideo(){let e=0;null!==this.localVideo.srcObject&&e++;for(let t of this.calls)null!==t.elt&&e++;return e}resize(){switch(this.nVideo=this._nVideo(),this.layout){case"linear":this.canvas.width=(this.width+this.frame)*this.nVideo,this.canvas.height=this.height;break;case"compact":this.nVideo<=2?(this.canvas.width=(this.width+this.frame)*this.nVideo,this.canvas.height=this.height):this.nVideo<=4?(this.canvas.width=2*(this.width+this.frame),this.canvas.height=2*this.height+this.frame):(this.canvas.width=3*this.width,this.canvas.height=2*this.height+this.frame)}this.canvasCtx.fillStyle=this.canvasBackground,this.canvasCtx.fillRect(0,0,this.canvas.width,this.canvas.height),this.calls.sort((e,t)=>e.call.data._line_index-t.call.data._line_index);let e=0;null!==this.localVideo.srcObject&&e++;for(let t of this.calls)if(null!==t.elt){let[s,i]=this._location(e);t.x=s,t.y=i,e++}}_location(e){let t=this.width+this.frame,s=this.height+this.frame;switch(this.layout){case"linear":return[e*t,0];case"compact":switch(this.nVideo){case 0:case 1:case 2:return[e*t,0];case 3:return e<2?[t,0]:[t*(e-2)+.5*t,s];case 4:return e<2?[t,0]:[t*(e-2),s];case 5:return e<3?[t*e,0]:[t*(e-3)+.5*t,s];case 6:return e<3?[t*e,0]:[t*(e-3),s]}}}_draw(){if(this.run){try{if(this.nVideo>0){null!==this.localVideo.srcObject&&this.canvasCtx.drawImage(this.localVideo,0,0,this.width,this.height);for(let e of this.calls)null!==e.elt&&this.canvasCtx.drawImage(e.elt,e.x,e.y,this.width,this.height)}}catch(e){console.log(e)}setTimeout(this._draw.bind(this),this.drawInterval)}}toString(){return this.run?"video mixer "+this.calls.map(e=>`${e.call.data._line_index+1}${null!==e.mix?"s":""}${null!==e.elt?"r":""}`):"video mixer is off"}}
